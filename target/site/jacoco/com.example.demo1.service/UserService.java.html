<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">demo1</a> &gt; <a href="index.source.html" class="el_package">com.example.demo1.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.example.demo1.service;

import com.example.demo1.model.Role;
import com.example.demo1.model.User;
import com.example.demo1.repository.UserRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;

import java.util.List;
import java.util.Optional;

@Service
<span class="fc" id="L17">public class UserService {</span>

<span class="fc" id="L19">    private static final Logger logger = LoggerFactory.getLogger(UserService.class);</span>
    private static final int MIN_PASSWORD_LENGTH = 8;

    @Autowired
    private UserRepository userRepository;

    @Autowired
    private PasswordEncoder passwordEncoder;

    /**
     * Register a user
     * âœ… Throws IllegalArgumentException for weak password or duplicate email
     * âœ… Encodes password and assigns USER role
     */
    public User registerUser(User user) {
<span class="fc" id="L34">        logger.info(&quot;Attempting to register user with email: {}&quot;, user.getEmail());</span>

<span class="fc" id="L36">        validateUserRegistration(user);</span>

<span class="fc bfc" id="L38" title="All 2 branches covered.">        if (userRepository.existsByEmail(user.getEmail())) {</span>
<span class="fc" id="L39">            logger.warn(&quot;Registration failed - duplicate email: {}&quot;, user.getEmail());</span>
<span class="fc" id="L40">            throw new IllegalArgumentException(&quot;User already exists with email: &quot; + user.getEmail());</span>
        }

<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (!isPasswordStrong(user.getPassword())) {</span>
<span class="nc" id="L44">            logger.warn(&quot;Registration failed - weak password for email: {}&quot;, user.getEmail());</span>
<span class="nc" id="L45">            throw new IllegalArgumentException(&quot;Password must be at least &quot; + MIN_PASSWORD_LENGTH + &quot; characters long&quot;);</span>
        }

        // Prepare user for registration
<span class="fc" id="L49">        User userToSave = prepareUserForRegistration(user);</span>

<span class="fc" id="L51">        User savedUser = userRepository.save(userToSave);</span>
<span class="fc" id="L52">        logger.info(&quot;User registered successfully with ID: {}&quot;, savedUser.getId());</span>

<span class="fc" id="L54">        return savedUser;</span>
    }

    /**
     * Authenticate user
     */
    public boolean authenticateUser(String email, String rawPassword) {
<span class="fc" id="L61">        logger.debug(&quot;Authenticating user with email: {}&quot;, email);</span>

<span class="pc bpc" id="L63" title="2 of 4 branches missed.">        if (!StringUtils.hasText(email) || !StringUtils.hasText(rawPassword)) {</span>
<span class="nc" id="L64">            logger.warn(&quot;Authentication failed - empty email or password&quot;);</span>
<span class="nc" id="L65">            return false;</span>
        }

<span class="fc" id="L68">        Optional&lt;User&gt; userOptional = userRepository.findByEmail(email.trim());</span>

<span class="fc bfc" id="L70" title="All 2 branches covered.">        if (userOptional.isEmpty()) {</span>
<span class="fc" id="L71">            logger.warn(&quot;Authentication failed - user not found: {}&quot;, email);</span>
<span class="fc" id="L72">            return false;</span>
        }

<span class="fc" id="L75">        User user = userOptional.get();</span>
<span class="fc" id="L76">        boolean isAuthenticated = passwordEncoder.matches(rawPassword, user.getPassword());</span>

<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (isAuthenticated) {</span>
<span class="fc" id="L79">            logger.info(&quot;User authenticated successfully: {}&quot;, email);</span>
        } else {
<span class="nc" id="L81">            logger.warn(&quot;Authentication failed - invalid password for: {}&quot;, email);</span>
        }

<span class="fc" id="L84">        return isAuthenticated;</span>
    }

    /**
     * Validate password
     */
    public boolean validatePassword(String rawPassword, String encodedPassword) {
<span class="pc bpc" id="L91" title="2 of 4 branches missed.">        if (!StringUtils.hasText(rawPassword) || !StringUtils.hasText(encodedPassword)) {</span>
<span class="nc" id="L92">            return false;</span>
        }
<span class="fc" id="L94">        return passwordEncoder.matches(rawPassword, encodedPassword);</span>
    }

    /**
     * Find user by email with validation
     */
    public Optional&lt;User&gt; findByEmail(String email) {
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (!StringUtils.hasText(email)) {</span>
<span class="nc" id="L102">            return Optional.empty();</span>
        }
<span class="fc" id="L104">        return userRepository.findByEmail(email.trim());</span>
    }

    /**
     * Get all users with logging
     */
    public List&lt;User&gt; getAllUsers() {
<span class="nc" id="L111">        logger.debug(&quot;Fetching all users&quot;);</span>
<span class="nc" id="L112">        List&lt;User&gt; users = userRepository.findAll();</span>
<span class="nc" id="L113">        logger.info(&quot;Retrieved {} users from database&quot;, users.size());</span>
<span class="nc" id="L114">        return users;</span>
    }

    /**
     * Get user by ID with validation
     */
    public Optional&lt;User&gt; getUserById(Long id) {
<span class="nc bnc" id="L121" title="All 4 branches missed.">        if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L122">            return Optional.empty();</span>
        }
<span class="nc" id="L124">        return userRepository.findById(id);</span>
    }

    /**
     * Delete user with validation and logging
     */
    public boolean deleteUser(Long id) {
<span class="nc bnc" id="L131" title="All 4 branches missed.">        if (id == null || id &lt;= 0) {</span>
<span class="nc" id="L132">            logger.warn(&quot;Delete user failed - invalid ID: {}&quot;, id);</span>
<span class="nc" id="L133">            return false;</span>
        }

<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (!userRepository.existsById(id)) {</span>
<span class="nc" id="L137">            logger.warn(&quot;Delete user failed - user not found with ID: {}&quot;, id);</span>
<span class="nc" id="L138">            return false;</span>
        }

        try {
<span class="nc" id="L142">            userRepository.deleteById(id);</span>
<span class="nc" id="L143">            logger.info(&quot;User deleted successfully with ID: {}&quot;, id);</span>
<span class="nc" id="L144">            return true;</span>
<span class="nc" id="L145">        } catch (Exception e) {</span>
<span class="nc" id="L146">            logger.error(&quot;Error deleting user with ID: {}&quot;, id, e);</span>
<span class="nc" id="L147">            return false;</span>
        }
    }

    // ============ NEW REFACTORED METHODS ============

    /**
     * ðŸ†• Check if user exists by email
     */
    public boolean userExists(String email) {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (!StringUtils.hasText(email)) {</span>
<span class="nc" id="L158">            return false;</span>
        }
<span class="fc" id="L160">        return userRepository.existsByEmail(email.trim());</span>
    }

    /**
     * ðŸ†• Validate password strength
     */
    public boolean isPasswordStrong(String password) {
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        if (!StringUtils.hasText(password)) {</span>
<span class="nc" id="L168">            return false;</span>
        }
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">        return password.length() &gt;= MIN_PASSWORD_LENGTH;</span>
    }

    /**
     * ðŸ†• Update user profile
     */
    public Optional&lt;User&gt; updateUser(Long id, User userUpdates) {
<span class="nc bnc" id="L177" title="All 6 branches missed.">        if (id == null || id &lt;= 0 || userUpdates == null) {</span>
<span class="nc" id="L178">            return Optional.empty();</span>
        }

<span class="nc" id="L181">        Optional&lt;User&gt; existingUser = userRepository.findById(id);</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (existingUser.isEmpty()) {</span>
<span class="nc" id="L183">            logger.warn(&quot;Update failed - user not found with ID: {}&quot;, id);</span>
<span class="nc" id="L184">            return Optional.empty();</span>
        }

<span class="nc" id="L187">        User user = existingUser.get();</span>
<span class="nc" id="L188">        updateUserFields(user, userUpdates);</span>

<span class="nc" id="L190">        User updatedUser = userRepository.save(user);</span>
<span class="nc" id="L191">        logger.info(&quot;User updated successfully with ID: {}&quot;, id);</span>

<span class="nc" id="L193">        return Optional.of(updatedUser);</span>
    }

    /**
     * ðŸ†• Change user role (admin function)
     */
    public Optional&lt;User&gt; changeUserRole(Long id, Role newRole) {
<span class="nc bnc" id="L200" title="All 6 branches missed.">        if (id == null || id &lt;= 0 || newRole == null) {</span>
<span class="nc" id="L201">            return Optional.empty();</span>
        }

<span class="nc" id="L204">        Optional&lt;User&gt; userOptional = userRepository.findById(id);</span>
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (userOptional.isEmpty()) {</span>
<span class="nc" id="L206">            return Optional.empty();</span>
        }

<span class="nc" id="L209">        User user = userOptional.get();</span>
<span class="nc" id="L210">        user.setRole(newRole);</span>

<span class="nc" id="L212">        User updatedUser = userRepository.save(user);</span>
<span class="nc" id="L213">        logger.info(&quot;User role changed to {} for ID: {}&quot;, newRole, id);</span>

<span class="nc" id="L215">        return Optional.of(updatedUser);</span>
    }

    // ============ PRIVATE HELPER METHODS ============

    /**
     * Validate user registration data
     */
    private void validateUserRegistration(User user) {
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L225">            throw new IllegalArgumentException(&quot;User cannot be null&quot;);</span>
        }

<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (!StringUtils.hasText(user.getName())) {</span>
<span class="fc" id="L229">            throw new IllegalArgumentException(&quot;User name is required&quot;);</span>
        }

<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (!StringUtils.hasText(user.getEmail())) {</span>
<span class="nc" id="L233">            throw new IllegalArgumentException(&quot;Email is required&quot;);</span>
        }

<span class="fc bfc" id="L236" title="All 2 branches covered.">        if (!isValidEmail(user.getEmail())) {</span>
<span class="fc" id="L237">            throw new IllegalArgumentException(&quot;Invalid email format&quot;);</span>
        }

<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (!StringUtils.hasText(user.getPassword())) {</span>
<span class="nc" id="L241">            throw new IllegalArgumentException(&quot;Password is required&quot;);</span>
        }
<span class="fc" id="L243">    }</span>

    /**
     * Prepare user for registration
     */
    private User prepareUserForRegistration(User user) {
<span class="fc" id="L249">        User userToSave = new User();</span>
<span class="fc" id="L250">        userToSave.setName(user.getName().trim());</span>
<span class="fc" id="L251">        userToSave.setEmail(user.getEmail().trim().toLowerCase());</span>
<span class="fc" id="L252">        userToSave.setPassword(passwordEncoder.encode(user.getPassword()));</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        userToSave.setRole(user.getRole() != null ? user.getRole() : Role.USER);</span>
<span class="fc" id="L254">        return userToSave;</span>
    }

    /**
     * Update user fields selectively
     */
    private void updateUserFields(User existingUser, User updates) {
<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (StringUtils.hasText(updates.getName())) {</span>
<span class="nc" id="L262">            existingUser.setName(updates.getName().trim());</span>
        }

<span class="nc bnc" id="L265" title="All 4 branches missed.">        if (StringUtils.hasText(updates.getEmail()) &amp;&amp; isValidEmail(updates.getEmail())) {</span>
            // Check if new email is not already taken by another user
<span class="nc bnc" id="L267" title="All 2 branches missed.">            if (!existingUser.getEmail().equalsIgnoreCase(updates.getEmail().trim()) &amp;&amp;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                    userRepository.existsByEmail(updates.getEmail().trim())) {</span>
<span class="nc" id="L269">                throw new IllegalArgumentException(&quot;Email already taken: &quot; + updates.getEmail());</span>
            }
<span class="nc" id="L271">            existingUser.setEmail(updates.getEmail().trim().toLowerCase());</span>
        }

<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (StringUtils.hasText(updates.getPassword())) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (!isPasswordStrong(updates.getPassword())) {</span>
<span class="nc" id="L276">                throw new IllegalArgumentException(&quot;Password must be at least &quot; + MIN_PASSWORD_LENGTH + &quot; characters long&quot;);</span>
            }
<span class="nc" id="L278">            existingUser.setPassword(passwordEncoder.encode(updates.getPassword()));</span>
        }

<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (updates.getRole() != null) {</span>
<span class="nc" id="L282">            existingUser.setRole(updates.getRole());</span>
        }
<span class="nc" id="L284">    }</span>

    /**
     * Basic email validation
     */
    private boolean isValidEmail(String email) {
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">        if (!StringUtils.hasText(email)) {</span>
<span class="nc" id="L291">            return false;</span>
        }
<span class="fc" id="L293">        String emailRegex = &quot;^[A-Za-z0-9+_.-]+@(.+)$&quot;;</span>
<span class="fc" id="L294">        return email.matches(emailRegex);</span>
    }

    /**
     * ðŸ†• Get user count
     */
    public long getUserCount() {
<span class="nc" id="L301">        return userRepository.count();</span>
    }

    /**
     * ðŸ†• Check if user is admin
     */
    public boolean isAdmin(Long userId) {
<span class="nc bnc" id="L308" title="All 4 branches missed.">        if (userId == null || userId &lt;= 0) {</span>
<span class="nc" id="L309">            return false;</span>
        }
<span class="nc" id="L311">        return userRepository.findById(userId)</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">                .map(user -&gt; user.getRole() == Role.ADMIN)</span>
<span class="nc" id="L313">                .orElse(false);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>